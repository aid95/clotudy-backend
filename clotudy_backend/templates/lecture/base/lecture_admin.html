{% load static %}<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
<!-- BEGIN: Head-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="description" content="Vuexy admin is super flexible, powerful, clean &amp; modern responsive bootstrap 4 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Vuexy admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="PIXINVENT">
    <title>CLOTUDY :: {% block title %}{% endblock %} - 관리자</title>
    <link rel="apple-touch-icon" href="{% static 'app-assets/images/ico/apple-icon-120.png' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'app-assets/images/ico/favicon.ico' %}">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600" rel="stylesheet">

    <!-- BEGIN: Vendor CSS-->
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/vendors.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/vendors/css/charts/apexcharts.css' %}">
    <!-- END: Vendor CSS-->

    <!-- BEGIN: Theme CSS-->
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/bootstrap.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/bootstrap-extended.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/colors.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/components.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/themes/dark-layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/themes/semi-dark-layout.css' %}">

    <!-- BEGIN: Page CSS-->
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/core/menu/menu-types/vertical-menu.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/core/colors/palette-gradient.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'app-assets/css/pages/app-email.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.7/ace.js" integrity="sha256-C7DTYRJLG+B/VEzHGeoPMw699nsTQYPAXHKXZb+q04E=" crossorigin="anonymous"></script>
    <!-- END: Page CSS-->

    <!-- BEGIN: Custom CSS-->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/style.css' %}">
    <!-- END: Custom CSS-->

    {% block extra-style %}{% endblock %}
</head>
<!-- END: Head-->

<!-- BEGIN: Body-->

<body class="vertical-layout vertical-menu-modern 2-columns  navbar-floating footer-static   menu-collapsed" data-open="click" data-menu="vertical-menu-modern" data-col="2-columns">

{% include 'lecture/menubar/header.html' %}

{% include 'lecture/menubar/side.html' %}

<!-- BEGIN: Content-->
<div class="app-content content">
    <div class="content-overlay"></div>
    <div class="header-navbar-shadow"></div>
    <div class="content-wrapper">
        <div class="content-header row">
            <div class="content-header-left col-md-9 col-12 mb-2">
                <div class="row breadcrumbs-top">
                    <div class="col-12">
                        <h2 class="content-header-title float-left mb-0">{{ page_name }}</h2>
                        <div class="breadcrumb-wrapper col-12">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'home' %}">홈</a>
                                </li>
                                <li class="breadcrumb-item"><a href="/lecture/list">강의 목록</a>
                                </li>
                                <li class="breadcrumb-item active">{{ lecture_data.title }}</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-header-right text-md-right col-md-3 col-12 d-md-block d-none">
                <div class="form-group breadcrum-right">
                    <div class="dropdown">
                        <button class="btn-icon btn btn-primary btn-round btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="feather icon-settings"></i></button>
                        <div class="dropdown-menu dropdown-menu-right"><a class="dropdown-item" href="#">Chat</a><a class="dropdown-item" href="#">Email</a><a class="dropdown-item" href="#">Calendar</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content-body">
            <!-- Nav Centered And Nav End Starts -->
            <section id="nav-tabs-centered">
                <div class="row">
                    <div class="col-sm-5">
                        <div class="card overflow-hidden">
                            <div class="card-header">
                                <h4 class="card-title">PPT 관리</h4>
                                <i data-toggle="tooltip" data-placement="left" title="새 창으로 PPT viewer 띄워 다양한 디스플레이에 표시할 수 있습니다." onclick="javascript:clonePPT();" class="fa fa-clone"></i>
                            </div>
                            <div class="card-content">
                                <div class="card-body text-center">
                                    <iframe id="ppt-frame" style="border: none; min-height: 500px; height: 100%; width: 100%;" allowfullscreen webkitallowfullscreen src="/lecture/pdf/?file=/static/pdfs/{{ lecture_data.pdf_path }}"></iframe>
                                    <div class="btn-group btn-group-lg mt-1" role="group" aria-label="Basic example">
                                        <button onclick="remotePPTPageSync(-1)" type="button" class="btn btn-secondary">Left</button>
                                        <button type="button" class="btn btn-secondary">Middle</button>
                                        <button onclick="remotePPTPageSync(1)" type="button" class="btn btn-secondary">Right</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-7">
                        <div class="card overflow-hidden">
                            <div class="card-header">
                                <h4 class="card-title">수업 관리 <small class="font-size-small text-muted">수업에 유용한 기능들을 이용해보세요.</small></h4>
                            </div>
                            <div class="card-content">
                                <div class="card-body">
                                    <ul class="nav nav-tabs justify-content-center" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="home-tab-center" data-toggle="tab" href="#home-center" aria-controls="home-center" role="tab" aria-selected="true">수업</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="service-tab-center" data-toggle="tab" href="#service-center" aria-controls="service-center" role="tab" aria-selected="false">질문</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-tab-center" data-toggle="tab" href="#account-center" aria-controls="account-center" role="tab" aria-selected="false">퀴즈</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="note-tab-center" data-toggle="tab" href="#note-center" aria-controls="note-center" role="tab" aria-selected="false">학습 자료</a>
                                        </li>
                                    </ul>
                    
                                    <div class="tab-content">
                                        <!-- Tab -->
                                        <div class="tab-pane active" id="home-center" aria-labelledby="home-tab-center" role="tabpanel">
                                            <h5 class="mt-2">일정</h5><hr />
                                            <h5 class="mt-2">진도</h5><hr />
                                            <div class="col-sm-6">
                                                <div class="progress progress-bar-info progress-lg">
                                                    <div class="progress-bar" role="progressbar" aria-valuenow="80" aria-valuemin="80" aria-valuemax="100" style="width:80%">80%</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                    
                                            </div>
                                            <h5 class="mt-2">PPT 정보</h5><hr />
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div id="ppt-waiting-chart"></div>
                                                </div>
                                                <div class="col-md-6">
                                                    <!-- Line Area Chart -->
                                                    <div id="line-area-chart"></div>
                                                </div>
                                            </div>
                                            <h5 class="mt-2">년도별 비교</h5><hr />
                                        </div>
                    
                                        <!-- Tab -->
                                        <div class="tab-pane" id="service-center" aria-labelledby="service-tab-center" role="tabpanel">
                                            <div class="email-application">
                                                <div class="app-content" style="margin: 0; overflow-y: auto; max-height: 500px;">
                                                    <div class="content-area-wrapper" style="margin: 0; display: block; border: none;">
                                                        <div class="email-user-list list-group" style="height: 100%;">
                                                            <ul id="questions-tab-list" class="users-list-wrapper media-list">
                                                                {% for obj in questions %}
                                                                <li class="media">
                                                                    <div class="media-left pr-50">
                                                                        <div class="avatar">
                                                                            <img src="{% static 'app-assets/images/portrait/small/avatar-s-20.jpg' %}" alt="avtar img holder">
                                                                        </div>
                                                                        <div class="user-action">
                                                                            <span class="favorite"><i class="feather icon-star"></i>{{ obj.like_count }}</span>
                                                                        </div>
                                                                    </div>
                                                                    <div class="media-body">
                                                                        <div class="user-details">
                                                                            <div class="mail-items">
                                                                                <h5 class="list-group-item-heading text-bold-600 mb-25">{{ obj.username }}</h5>
                                                                                <span class="list-group-item-text text-truncate">컴퓨터공학부 게임모바일컨텐츠학과</span>
                                                                            </div>
                                                                            <div class="mail-meta-item">
                                                                                    <span class="float-right">
                                                                                        <span class="mr-1 bullet bullet-success bullet-sm"></span><span class="mail-date">4:14 AM</span>
                                                                                    </span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="mail-message">
                                                                            <p class="list-group-item-text truncate mb-0">{{ obj.content }}</p>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                {% endfor %}
                                                            </ul>
                                                            <div class="no-results">
                                                                <h5>No Items Found</h5>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                    
                                        <!-- Tab -->
                                        <div class="tab-pane" id="account-center" aria-labelledby="account-tab-center" role="tabpanel">
                                            <div id="accordion">
                                                {% for quiz in quiz_data %}
                                                    <div class="card mb-0">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapse-{{ quiz.category_id }}" aria-expanded="false" aria-controls="collapse-{{ quiz.category_id }}">
                                                                {{ quiz.category_title }}
                                                            </button>
                                                        </h5>
                                                    </div>
                    
                                                    <div id="collapse-{{ quiz.category_id }}" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <div class="col-md-8">
                                                                    <div class="nav-vertical">
                                                                        <ul class="nav nav-tabs nav-left flex-column" role="tablist">
                                                                            {% for prob in quiz.quiz_content %}
                                                                                <li class="nav-item">
                                                                                    {% if forloop.counter == 1 %}
                                                                                        <a class="nav-link active" id="baseVerticalLeft-tab{{ forloop.counter }}" data-toggle="tab" aria-controls="tabVerticalLeft{{ forloop.counter }}" href="#tabVerticalLeft{{ prob.id }}" role="tab" aria-selected="true">문제 {{ forloop.counter }}</a>
                                                                                    {% else %}
                                                                                        <a class="nav-link" id="baseVerticalLeft-tab{{ forloop.counter }}" data-toggle="tab" aria-controls="tabVerticalLeft{{ forloop.counter }}" href="#tabVerticalLeft{{ prob.id }}" role="tab" aria-selected="false">문제 {{ forloop.counter }}</a>
                                                                                    {% endif %}
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                    
                                                                        <div class="tab-content">
                                                                            {% for prob in quiz.quiz_content %}
                                                                                {% if forloop.counter == 1 %}
                                                                                <div class="tab-pane active" id="tabVerticalLeft{{ prob.id }}" role="tabpanel" aria-labelledby="baseVerticalLeft-tab{{ forloop.counter }}">
                                                                                {% else %}
                                                                                <div class="tab-pane" id="tabVerticalLeft{{ prob.id }}" role="tabpanel" aria-labelledby="baseVerticalLeft-tab{{ forloop.counter }}">
                                                                                {% endif %}
                    
                                                                                <p class="mb-1">{{ prob.problem }}</p><hr />
                                                                                {% for answer_item in prob.answer %}
                                                                                    <p>{{ forloop.counter }}. {{ answer_item.content }}</p>
                                                                                    <div class="progress progress-bar-info progress-lg mb-1">
                                                                                        <div id="answer-elem-{{ answer_item.id }}" class="progress-bar" role="progressbar" aria-valuenow="{{ answer_item.choice_count }}" aria-valuemin="0" aria-valuemax="100" style="width:{{ answer_item.choice_count_percent }}%">{{ answer_item.choice_count }}</div>
                                                                                    </div>
                                                                                {% endfor %}
                                                                                </div>
                                                                            {% endfor %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                    
                                                                    <div class="col-md-4">
                                                                        <div class="row">
                                                                            <div class="col-md-12">
                                                                                <div class="card">
                                                                                    <div class="card-header">문항별 정답률</div>
                                                                                    <div class="card-body"><div id="q2Chart"></div></div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="col-md-12">
                                                                                <div class="card">
                                                                                    <div class="card-header">점수 분포</div>
                                                                                    <div class="card-body"><div id="q1Chart"></div></div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <button onclick="showQuizModal({{ quiz.category_id }})" class="btn btn-primary">시작하기</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                </div>
                                            </div>
                                        <!-- Tab -->
                                        <div class="tab-pane" id="note-center" aria-labelledby="note-tab-center" role="tabpanel">
                                            {{ lecture_data.lecture_note|safe }}
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </section>
            <!-- Nav Centered And Nav End Ends -->
        </div>
    </div>
</div>
<!-- END: Content-->

<div class="sidenav-overlay"></div>
<div class="drag-target"></div>

<!-- BEGIN: Footer-->
<footer class="footer footer-static footer-light">
    <p class="clearfix blue-grey lighten-2 mb-0"><span class="float-md-left d-block d-md-inline-block mt-25">COPYRIGHT &copy; 2019<a class="text-bold-800 grey darken-2" href="https://1.envato.market/pixinvent_portfolio" target="_blank">Pixinvent,</a>All rights Reserved</span><span class="float-md-right d-none d-md-block">Hand-crafted & Made with<i class="feather icon-heart pink"></i></span>
        <button class="btn btn-primary btn-icon scroll-top" type="button"><i class="feather icon-arrow-up"></i></button>
    </p>
</footer>
<!-- END: Footer-->

<!-- BEGIN: Vendor JS-->
<script src="{% static 'app-assets/vendors/js/vendors.min.js' %}"></script>
<script src="{% static 'app-assets/vendors/js/charts/apexcharts.min.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
<!-- BEGIN Vendor JS-->

<!-- BEGIN: Page Vendor JS-->
<!-- END: Page Vendor JS-->

<!-- BEGIN: Theme JS-->
<script src="{% static 'app-assets/js/core/app-menu.js' %}"></script>
<script src="{% static 'app-assets/js/core/app.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/components.js' %}"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!-- END: Theme JS-->

<!-- BEGIN: Page JS-->
<script src="{% static 'app-assets/js/scripts/navs/navs.js' %}"></script>
<script src="{% static 'app-assets/js/scripts/pages/app-email.js' %}"></script>
<script src="{% static 'assets/js/lecture_util.js' %}"></script>
<!-- END: Page JS-->

<script>
    let delta_time;
    let last_time = getCurrentTime();
    let currentPage = 1;
    let sync_lock = true;
    let lecture_id = {{ room_name_json }};
    let qna_messages;
    let is_exist_new_qna = true;

    $(document).ready(function(){
        qna_messages = {{ questions|safe }};
    });

    function clonePPT() {
        let handle = window.open("/lecture/pdf/?file=/static/pdfs/{{ lecture_data.pdf_path }}", "", "width=370, height=360, resizable=no, scrollbars=no, status=no;");
    }

    function remotePPTPageSync(v) {
        if (sync_lock) {
            sync_lock = false;
            let currentPage = document.getElementById("ppt-frame").contentWindow.PDFViewerApplication.page;
            let tmpPage = currentPage + v;
            let numPages = document.getElementById("ppt-frame").contentWindow.PDFViewerApplication.pagesCount;
            if((tmpPage > numPages) || (tmpPage < 1)) {
                sync_lock = true;
                return;
            }
            addPptTime(currentPage, numPages);
            currentPage = tmpPage;
            document.getElementById("ppt-frame").contentWindow.PDFViewerApplication.page = currentPage;
            global_socket.send(JSON.stringify({
                'action': 'sync-ppt-page',
                'data': {
                    'page': currentPage
                }
            }));
            sync_lock = true;
        }
    }
    
    function liveQnAMessage(request) {
        let {content, message_id, username, like_count} = request.data;
        if (content === '') {
            return
        }
        qna_messages.push({content, username, like_count, message_id});
        is_exist_new_qna = true;
    
        let live_qna_chat_box = $('#questions-tab-list');
        live_qna_chat_box.append(
            get_question_message_html(content, username, like_count, message_id)
        );
    }

    function updateQuizInfo(data) {
        axios.get(`/api/quiz/{{ class_id }}/${data.data.quiz_id}`).then(res => {
            updateQuizHtml(res);
        });
    }
    
    function updateQuizHtml(data) {
        console.log(data);
        for (let i = 0; i < data.data[0].quiz_content.length; i++) {
            let quiz_obj = data.data[0].quiz_content[i];
            for (let j = 0; j < quiz_obj.answer.length; j++) {
                var answer_obj = quiz_obj.answer[j];
    
                try {
                    var aid = answer_obj.id;
                    var acount = answer_obj.choice_count;
                    var apercent = answer_obj.choice_count_percent;
                    $(`#answer-elem-${aid}`).html(acount);
                    $(`#answer-elem-${aid}`).attr('aria-valuenow', acount);
                    $(`#answer-elem-${aid}`).attr('style', `width:${apercent}%`);
                }
                catch(err) {
                    return;
                }
            }
        }
    }
    
    function showQuizModal(quizBoxId) {
        global_socket.send(JSON.stringify({
            'action': 'show-quiz-modal',
            'data': {
                'qid': quizBoxId,
            }
        }));
    }

    function addPptTime(page, max_pages) {
        let cur_time = getCurrentTime();
        let delta_time = (cur_time - last_time) / 1000;
        last_time = cur_time;
    
        let times = ppt_chart.w.globals.series.slice()[0];
        if (times.length < max_pages) {
        times = Array(max_pages).fill(0)
        }
        if (!times.hasOwnProperty(page) && 1 <= page && page <= max_pages) {
        times[page-1] = delta_time;
        } else {
        times[page-1] += delta_time;
        }
        ppt_chart.updateSeries([{data: times}]);
    }

    function savePPTTime() {
        let times = ppt_chart.w.globals.series.slice()[0];
        let history_str = "";
        for (let i = 0; i < times.length; i++) {
            history_str += parseInt(times[i]) + ";";
        }
    
        axios({
                method: 'post',
                url: `/api/ppthistory/${lecture_id}`,
                data: {
                    'history': history_str.slice(0, -1),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                headers: {
                    "content-type": "application/json"
                }
                }).then(function (response) {
                    console.log(response)
                }).catch(function (error) {
                    console.log(error)
                });
    }
    setInterval(savePPTTime, 60000);

    function get_question_message_html_for_admin(content, username, like_count, message_id) {
        return $("<li>").addClass("media").append(
            $("<div>").addClass("media-left pr-50").append(
                $("<div>").addClass("avatar").append(
                    $("<img>").attr("src", "{% static 'app-assets/images/portrait/small/avatar-s-20.jpg' %}").attr("alt", "avatar img holder")
                ),
                $("<div>").addClass("user-action").append(
                    $("<span>").addClass("favorite").append(
                        $("<i>").addClass("feather icon-star"),
                        $("<span>").html(like_count)
                    )
                )
            ),
            $("<div>").addClass("media-body").append(
                $("<div>").addClass("user-details").append(
                    $("<div>").addClass("mail-iterms").append(
                        $("<h5>").addClass("list-group-item-heading text-bold-600 mb-25").html(username),
                    ),
                    $("<div>").addClass("mail-meta-item").append(
                        $("<span>").addClass("float-right").append(
                            $("<span>").addClass("mr-1 bullet bullet-success bullet-sm"),
                            $("<span>").addClass("mail-date").html("7:77 AM")
                        )
                    )
                ),
                $("<div>").addClass("mail-message").append(
                    $("<p>").addClass("list-group-item-text truncate mb-0").html(content)
                )
            )
        )
    }

    function redrawSortingQnAChat() {
        if (!is_exist_new_qna) {
            return;
        } else {
            is_exist_new_qna = false;
        }
    
        $('#questions-tab-list').empty();
        qna_messages.sort((lhs, rhs) => {
            return rhs['like_count'] - lhs['like_count'];
        });
        qna_messages.forEach((message) => {
            let {content, username, like_count, message_id} = message;
            $('#questions-tab-list').append(
                get_question_message_html_for_admin(content, username, like_count, message_id)
            );
        });
    }
    setInterval(redrawSortingQnAChat, 5000);

    function updateLikeCount(data) {
        let message_id = data['data']['message_id'];
        for (let i = 0; i < qna_messages.length; i++) {
            if (qna_messages[i]['message_id'] === message_id) {
                qna_messages[i]['like_count'] += 1;
                break;
            }
        }
    }
</script>
{% block extra-script %}{% endblock %}
</body>
<!-- END: Body-->
</html>
